# NeuronServer Builder (Phase 7A.8)

This document designs the “minimal ceremony” server builder used to wire:
- a `GraphStore` implementation
- provider implementations (`EmbeddingProvider`, `LLMProvider`)
- an analysis pipeline runner
- API route handlers

The goal is to make extensibility possible without forcing consumers into a DI framework.

## Why a builder?

Today, the wiring happens in multiple places:
- `createNeuronRoutes(config)` creates routes and each route creates repositories/DB connections.
- `createAnalyzeRoutes` and `createSearchRoutes` build OpenAI-dependent services ad hoc.
- CLI builds its own pipeline.

This fragments configuration and makes it hard to swap providers/stores consistently.

## Proposed v1 shape

### `NeuronServer` object
The server object should hold the “resolved” runtime dependencies:
- `store: GraphStore`
- `providers: { embedding?: EmbeddingProvider; llm?: LLMProvider }`
- `pipeline: AnalysisPipeline` (compat wrapper) OR a new pipeline runner interface
- `routes: ReturnType<typeof createNeuronRoutes>` (route handlers)

### Builder function(s)

Primary:
- `createNeuronServer(options)`
  - accepts explicit `store` and `providers` (advanced usage)

Convenience:
- `createNeuronServerFromConfig(config: NeuronServerConfig | NeuronConfig)`
  - constructs `PostgresGraphStore` and OpenAI providers by default
  - preserves the current “single config file” experience

### Route factory integration
Two compatible ways to keep `createNeuronRoutes` stable:

Option A (preferred): route factory accepts either `NeuronConfig` or `NeuronServer`
- `createNeuronRoutes(configOrServer)`
  - if given config, internally builds server defaults
  - if given server, reuses injected store/providers

Option B: add a parallel API
- keep `createNeuronRoutes(config)` unchanged
- add `createNeuronRoutesFromServer(server)`

Either option is additive; Option B avoids changing existing call sites.

## Next.js usage pattern (recommended)

Server-only module:
- `neuron.server.ts`:
  - loads env secrets
  - calls `createNeuronServerFromConfig(...)`

Route handler:
- imports `server.routes` and exports GET/POST etc.

Client components:
- use `NeuronWebProvider` with client-safe config only (`basePath` etc).

## Backward-compatibility notes
- Existing `createNeuronRoutes(config)` remains supported.
- Existing route templates generated by `omi-neuron init` continue to compile.
- Provider injection and store swapping are opt-in.

