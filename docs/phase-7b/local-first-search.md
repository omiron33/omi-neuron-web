# Local-First Search Behavior (Phase 7B.6)

This document defines how semantic search and similarity behave in local-first backends (`memory` and `file`).

## Embedding storage
- Embeddings are stored on the node record:
  - `embedding: number[] | null`
  - `embeddingModel: string | null`
  - `embeddingGeneratedAt: Date | null` (serialized as ISO string in file mode)

This matches the existing Postgres schema fields on `nodes`.

## Similarity function

Local-first backends use cosine similarity:
- `cosine(a, b) = dot(a,b) / (||a|| * ||b||)`

Rules:
- If either vector is missing or zero-magnitude, similarity is `0`.
- Only compare vectors of equal length; if lengths differ, treat as `0` (or truncate consistently; v1 prefers `0` for safety).

## findSimilar behavior

Given a node ID:
- Look up the node's embedding.
- Scan all other nodes with embeddings.
- Compute similarity for each candidate.
- Sort descending by similarity.
- Apply `limit` and optional `minSimilarity`.

### Exclude connected (best-effort)
If requested:
- exclude nodes that have a direct edge connection to the source node.

## Semantic search behavior

Given a query embedding (generated by an embedding provider):
- Scan all nodes with embeddings.
- Compute similarity between each node embedding and the query embedding.
- Sort descending and return top-N.

## Limitations vs pgvector
- No index acceleration; O(n) scans are expected.
- No pgvector operator semantics (`<=>`); results may differ slightly from Postgres scoring.
- Suitable for small datasets and prototyping only.

## Determinism for tests
- Use a mock embedding provider (`MockEmbeddingProvider`) to produce stable embeddings.
- Ensure stable iteration order in stores (e.g., createdAt/id ordering) to avoid flaky ties.

